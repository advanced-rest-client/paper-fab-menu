<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../paper-fab/paper-fab.html">
<link rel="import" href="../paper-tooltip/paper-tooltip.html">
<link rel="import" href="../iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="paper-fab-menu-item.html">

<!--
@author Arshak Khachatrian (<a href="mailto:akhxtern@gmail.com">akhxtern@gmail.com</a>)
@website http://spacee.xyz
@updateDate May 14, 2016

This element has been modified by Pawel Psztyc <jarrodek@gmail.com> The ARC team.
-->

<!--
This floating action button is using the Material Design concept of expandable Paper Fab Button
and using the Polymer components to make the concept happen.

Use the `<paper-fab-menu>` to display menu-like fab buttons.

## Example

### Simple

    <paper-fab-menu color="teal" icon="add" position="vertical">
      <paper-fab-menu-item color="teal" tooltip="Favorites" icon="star" ></paper-fab-menu-item>
      <paper-fab-menu-item color="teal" tooltip="Favorites" icon="star" ></paper-fab-menu-item>
      <paper-fab-menu-item color="teal" tooltip="Favorites" icon="star" ></paper-fab-menu-item>
    </paper-fab-menu>

### With letters (without icons - Inbox style)

    <paper-fab-menu color="blue" icon="add" position="vertical">
      <paper-fab-menu-item color="red" label="A" tooltip="The letter A"></paper-fab-menu-item>
      <paper-fab-menu-item color="#9C27B0" label="B" tooltip="The letter B"></paper-fab-menu-item>
      <paper-fab-menu-item color="#2196F3" label="B" tooltip="The letter C"></paper-fab-menu-item>
    </paper-fab-menu>

### With links

    <paper-fab-menu color="red" icon="add" position="horizontal">
      <a href="#/favorites">
        <paper-fab-menu-item color="red" tooltip="Favorites" icon="star"></paper-fab-menu-item>
      </a>
      <a href="#/favorites">
        <paper-fab-menu-item color="red" tooltip="Favorites" icon="star"></paper-fab-menu-item>
      </a>
      <a href="#/favorites">
        <paper-fab-menu-item color="red" tooltip="Favorites" icon="star"></paper-fab-menu-item>
      </a>
    </paper-fab-menu>

@demo demo/demo.html  Super cool demo, with sharks!
-->



<dom-module id="paper-fab-menu">
    <style is="custom-style">
        :host {
          width: 60px;
        }

        /*:host .layout {
          max-width: ;
        }*/

        :host([position="vertical"]) .menu-fab-button {
          padding-top: 7px;
        }

        :host([position="horizontal"]) .menu-fab-button {
          padding-left: 7px;
        }

        :host-context([dir="rtl"]):host([position="horizontal"]) .menu-fab-button,
        :host-context([dir="rtl"])[position="horizontal"] .menu-fab-button,
        /* Polymer workaround */

        :host([dir="rtl"][position="horizontal"]) .menu-fab-button {
          padding-left: 0;
          padding-right: 7px;
        }

        :host .menu-items ::content a {
          display: block;
          margin: 7px;
        }

        :host .menu-items ::content a > paper-fab-menu-item {
          margin: 0;
        }

        :host .menu-items {
          order: 1;
        }

        :host .menu-fab-button {
          order: 2;
        }
    </style>
    <template>
      <div class$="layout {{position}} paper-fab-menu-container">
        <div id="mainFab" class="menu-fab-button layout vertical self-center">
          <paper-fab id="paperFab" icon="{{ icon }}"></paper-fab>
        </div>
        <div id="mainItems" class$="menu-items flex layout {{position}} self-center">
          <content id="items" select="a, paper-fab-menu-item"></content>
        </div>
      </div>
    </template>
    <script>
        Polymer({
            is: 'paper-fab-menu',
            properties: {
              /**
               * Vertical or horizontal position of the menu.
               */
              position: {
                type: String,
                value: 'vertical'
              },
              // True when the menu is opened.
              opened: {
                type: Number,
                value: false,
                notify: true
              },
              /**
               * The color of the main button.
               */
              color: String
            },
            listeners: {
              'mouseover': '_testOpen',
              'mouseout': '_testClose',
              'mainFab.mouseover': '_testOpen',
              'mainFab.mouseout': '_testClose',
              'mainItems.mouseover': '_testOpen',
              'mainItems.mouseout': '_testClose'
            },

            observers: [
              '_openedChanged(opened)',
              '_colorChanged(color)'
            ],

            ready: function() {
              this._childobserver = Polymer.dom(this.$.items).observeNodes(function(info) {
                this._updateDelay();
              }.bind(this));
              this.listen(document.body, 'click', '_detectClick');
            },

            detached: function() {
              Polymer.dom(this.$.items).unobserveNodes(this._childobserver);
              this.unlisten(document.body, 'click', '_detectClick');
            },

            // Opens the menu
            open: function() {
              this.opened = true;
            },

            // Closes the menu
            close: function() {
              this.opened = false;
            },

            // Tests if the menu should be opened and opens it if nescesary
            _testOpen: function(e) {
              if (this.opened) {
                return;
              }
              if (e.path[0].classList.contains('paper-fab-menu-container')) {
                return;
              }
              let isMain = true;
              for (let i = 0, len = e.path.length; i < len; i++) {
                let item = e.path[i];
                if (!item.classList) {
                  continue;
                }
                if (item.classList.contains('menu-items') ||
                  item.nodeName === 'PAPER-FAB-MENU-ITEM') {
                  isMain = false;
                  break;
                }
              }
              if (isMain) {
                this.opened = true;
              }
            },

            // Tests if the menu should be closed and closes it if nescesary
            _testClose: function(e) {
              if (!this.opened) {
                return;
              }
              var item = e.path[0];
              if (item && item.classList && item.classList.contains('paper-fab-menu-container')) {
                this.opened = false;
                return;
              } else if (item.id === 'tooltip') {
                this.opened = false;
                return;
              } else if (item.id === 'paperFab' && e.path[1].id === 'mainFab') {
                this.opened = false;
                return;
              }
            },

            // Opens or closes the menu depending on the argument.
            _openedChanged: function(opened) {
              var style = 'transition : 200ms all;transform : rotate(';
              style += opened ? '45' : '0';
              this.$.paperFab.customStyle['--paper-fab-iron-icon'] = style + 'deg);';
              this.$.paperFab.updateStyles();
              Polymer.dom(this).children.forEach(function(child) {
                if (child.nodeName === 'A') {
                  if (!child.children) {
                    return;
                  }
                  child = Array.from(child.children).find(function(item) {
                    return item.nodeName === 'PAPER-FAB-MENU-ITEM';
                  });
                }
                child && opened ? child.classList.add('opened') : child.classList.remove('opened');
              });
            },

            // Called when color has changed.
            _colorChanged: function (color) {
              this.customStyle['--paper-fab-background'] = color;
              this.updateStyles();
              // For some reason code above do not affect main fab at bootstrap time.
              this.$.paperFab.style.backgroundColor = color;
            },

            // Updates animation delay time attribute in distributed children.
            _updateDelay: function() {
              var time = 0;
              Polymer.dom(this).children.reverse().forEach(function(child) {
                child.transitionDelay = time;
                time += 50;
              });
            },

            // Closes menu on body click.
            _detectClick: function(e) {
              var ctrl = this;
              var isMainButton = e.path.some(function(item) {
                return item === ctrl;
              });
              if (isMainButton) {
                if (!this.opened) {
                  this.opened = true;
                }
                return;
              }
              this.opened = false;
            }
        })
    </script>
</dom-module>
